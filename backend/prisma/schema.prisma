generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model Standard {
  id          Int       @id @default(autoincrement())
  title       String    @unique
  type        String    // "PMBOK", "PRINCE2", "ISO", etc.
  version     String?   // "7th Edition", "2021", etc.
  description String?
  sections    Section[]
  chapters    Chapter[]

  @@index([type])
}

model Chapter {
  id          Int       @id @default(autoincrement())
  standardId  Int
  number      String    // "1", "2", "3", etc.
  title       String    // "INTRODUCTION", "PROJECT PERFORMANCE DOMAINS", etc.
  description String?
  sections    Section[]
  standard    Standard  @relation(fields: [standardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([standardId])
  @@unique([standardId, number])
}

model Section {
  id            Int                    @id @default(autoincrement())
  standardId    Int
  chapterId     Int?
  sectionNumber String                 // "1.1", "2.3.4", etc.
  title         String                 // "Structure of the PMBOK® Guide"
  fullTitle     String                 // "1.1 Structure of the PMBOK® Guide"
  content       String
  anchorId      String                 @unique
  wordCount     Int                    @default(0)
  sentenceCount Int                    @default(0)
  embedding     Unsupported("vector(1536)")?
  standard      Standard               @relation(fields: [standardId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  chapter       Chapter?               @relation(fields: [chapterId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([embedding])
  @@index([standardId])
  @@index([chapterId])
  @@index([sectionNumber])
  @@unique([standardId, sectionNumber])
}

model Topic {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  description       String?
  generatedInsights GeneratedInsight[]
}

model GeneratedInsight {
  id             Int      @id @default(autoincrement())
  topicId        Int
  comparisonData Json
  createdAt      DateTime @default(now())
  topic          Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([topicId])
}
